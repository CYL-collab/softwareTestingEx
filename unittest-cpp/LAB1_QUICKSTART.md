# LAB1 å¿«é€Ÿå¼€å§‹æŒ‡å—

## å®éªŒæ¦‚è¿°

æœ¬å®éªŒå°†æµ‹è¯• Minishell é¡¹ç›®â€”â€”ä¸€ä¸ªç®€åŒ–ç‰ˆçš„ Unix Shell å®ç°ã€‚ä½ å°†ä½¿ç”¨ GoogleTest æ¡†æ¶ç¼–å†™å•å…ƒæµ‹è¯•ï¼Œå®è·µå¤šç§é»‘ç›’æµ‹è¯•æ–¹æ³•ã€‚

## å­¦ä¹ ç›®æ ‡

1. æŒæ¡ GoogleTest æ¡†æ¶çš„åŸºæœ¬ç”¨æ³•
2. ç†è§£å¹¶åº”ç”¨å‚æ•°åŒ–æµ‹è¯•
3. å®è·µé»‘ç›’æµ‹è¯•æ–¹æ³•ï¼š
   - ç­‰ä»·ç±»åˆ’åˆ†
   - è¾¹ç•Œå€¼åˆ†æ
   - ç»„åˆæµ‹è¯•
   - å†³ç­–è¡¨æµ‹è¯•

## å®éªŒæ­¥éª¤

### Step 1: ç¯å¢ƒå‡†å¤‡ï¼ˆ15åˆ†é’Ÿï¼‰

1. **ç¼–è¯‘ Minishell**
   ```bash
   cd source/minishell
   make
   ./minishell  # æµ‹è¯•æ˜¯å¦èƒ½æ­£å¸¸è¿è¡Œ
   ```

2. **é…ç½®æµ‹è¯•ç¯å¢ƒ**
   ```bash
   cd ../../unittest-cpp
   cmake -S . -B build
   cmake --build build
   ```

### Step 2: ç†è§£æµ‹è¯•æ¡†æ¶ï¼ˆ20åˆ†é’Ÿï¼‰

é˜…è¯»ä»¥ä¸‹æ–‡ä»¶ä»¥ç†è§£æµ‹è¯•æ¡†æ¶ç»“æ„ï¼š

1. **`minishell_test_base.h`** - æµ‹è¯•åŸºç±»
   - æä¾› `executeCommand()` å‡½æ•°æ‰§è¡Œ minishell å‘½ä»¤
   - æä¾› `executeCommandGetExitCode()` è·å–é€€å‡ºç 
   - ç»§æ‰¿æ­¤ç±»å³å¯ä½¿ç”¨è¿™äº›è¾…åŠ©å‡½æ•°

2. **æµ‹è¯•æ–‡ä»¶ç»“æ„**
   ```cpp
   // 1. åŒ…å«æµ‹è¯•åŸºç±»
   #include "minishell_test_base.h"
   
   // 2. ç¼–å†™æµ‹è¯•ç”¨ä¾‹
   TEST_F(MinishellTestBase, TestName) {
       std::string output = executeCommand("echo Hello");
       EXPECT_TRUE(output.find("Hello") != std::string::npos);
   }
   
   // 3. å‚æ•°åŒ–æµ‹è¯•
   struct TestParam { /* å‚æ•°å®šä¹‰ */ };
   class ParamTest : public MinishellTestBase,
                     public ::testing::WithParamInterface<TestParam> {};
   
   TEST_P(ParamTest, TestName) {
       TestParam param = GetParam();
       // ä½¿ç”¨å‚æ•°è¿›è¡Œæµ‹è¯•
   }
   
   INSTANTIATE_TEST_SUITE_P(Name, ParamTest,
       ::testing::Values(
           TestParam{...},
           TestParam{...}
       )
   );
   ```

### Step 3: å®Œæˆå†…ç½®å‘½ä»¤æµ‹è¯•ï¼ˆ60åˆ†é’Ÿï¼‰

æ–‡ä»¶ï¼š`minishell_builtin_test.cc`

#### 3.1 ç­‰ä»·ç±»åˆ’åˆ† - Echo å‘½ä»¤

**æ€è€ƒ**ï¼šecho å‘½ä»¤æœ‰å“ªäº›ä¸åŒçš„ä½¿ç”¨æ–¹å¼ï¼Ÿ

- æ™®é€šå­—ç¬¦ä¸²ï¼š`echo Hello`
- å¸¦ç©ºæ ¼çš„å­—ç¬¦ä¸²ï¼š`echo "Hello World"`
- å¸¦å¼•å·çš„å­—ç¬¦ä¸²ï¼š`echo 'test'`
- ç¯å¢ƒå˜é‡ï¼š`echo $HOME`
- ç‰¹æ®Šé€‰é¡¹ï¼š`echo -n test`

**ä»»åŠ¡**ï¼šä¸ºè¿™äº›ç­‰ä»·ç±»ç¼–å†™æµ‹è¯•

ç¤ºä¾‹ï¼š
```cpp
TEST_F(MinishellTestBase, EchoSimpleString) {
    std::string output = executeCommand("echo Hello");
    EXPECT_TRUE(output.find("Hello") != std::string::npos);
}
```

#### 3.2 å‚æ•°åŒ–æµ‹è¯• - Echo å¤šç§è¾“å…¥

**ä¼˜åŠ¿**ï¼šé¿å…é‡å¤ä»£ç ï¼Œç³»ç»Ÿæ€§æµ‹è¯•å¤šä¸ªè¾“å…¥

```cpp
INSTANTIATE_TEST_SUITE_P(
    EchoTests,
    EchoParameterizedTest,
    ::testing::Values(
        EchoTestParam{"\"Hello World\"", "Hello World", "Double quotes"},
        EchoTestParam{"'Single'", "Single", "Single quotes"},
        // æ·»åŠ æ›´å¤š...
    )
);
```

**ä»»åŠ¡**ï¼šæ·»åŠ è‡³å°‘ 5 ä¸ªä¸åŒçš„æµ‹è¯•å‚æ•°

#### 3.3 è¾¹ç•Œå€¼åˆ†æ - cd å‘½ä»¤

**æ€è€ƒ**ï¼šcd å‘½ä»¤çš„è¾¹ç•Œå€¼æ˜¯ä»€ä¹ˆï¼Ÿ

- ç‰¹æ®Šç›®å½•ï¼š`~`, `/`, `.`, `..`
- ç©ºè·¯å¾„
- ä¸å­˜åœ¨çš„è·¯å¾„
- ç›¸å¯¹è·¯å¾„ vs ç»å¯¹è·¯å¾„

**ä»»åŠ¡**ï¼šæµ‹è¯•è¿™äº›è¾¹ç•Œå€¼

```cpp
INSTANTIATE_TEST_SUITE_P(
    CdBoundaryTests,
    CdCommandTest,
    ::testing::Values("~", "/", ".", "..", "/tmp")
);
```

### Step 4: å®Œæˆé‡å®šå‘æµ‹è¯•ï¼ˆ45åˆ†é’Ÿï¼‰

æ–‡ä»¶ï¼š`minishell_redirect_test.cc`

#### 4.1 åŸºæœ¬é‡å®šå‘æµ‹è¯•

æµ‹è¯•ä¸‰ç§é‡å®šå‘æ“ä½œç¬¦ï¼š
- `>` : è¾“å‡ºé‡å®šå‘ï¼ˆè¦†ç›–ï¼‰
- `>>` : è¿½åŠ é‡å®šå‘
- `<` : è¾“å…¥é‡å®šå‘

ç¤ºä¾‹ï¼š
```cpp
TEST_F(RedirectTest, SimpleOutputRedirect) {
    executeCommand("echo 'Hello' > " + temp_file);
    std::string content = readFile(temp_file);
    EXPECT_TRUE(content.find("Hello") != std::string::npos);
}
```

#### 4.2 ç»„åˆæµ‹è¯•

ä½¿ç”¨å‚æ•°åŒ–æµ‹è¯•ç»„åˆä¸åŒçš„å‘½ä»¤å’Œé‡å®šå‘æ“ä½œç¬¦ï¼š

| å‘½ä»¤ | æ“ä½œç¬¦ | é¢„æœŸç»“æœ |
|------|--------|----------|
| echo | >      | åˆ›å»ºæ–‡ä»¶ |
| echo | >>     | è¿½åŠ å†…å®¹ |
| pwd  | >      | ä¿å­˜è·¯å¾„ |
| ls   | >      | ä¿å­˜åˆ—è¡¨ |

**ä»»åŠ¡**ï¼šåˆ›å»ºè‡³å°‘ 6 ä¸ªç»„åˆ

### Step 5: å®Œæˆç®¡é“æµ‹è¯•ï¼ˆ45åˆ†é’Ÿï¼‰

æ–‡ä»¶ï¼š`minishell_pipe_test.cc`

#### 5.1 å†³ç­–è¡¨åˆ†æ

ç®¡é“åŠŸèƒ½æ¶‰åŠå¤šä¸ªæ¡ä»¶ï¼š

| è§„åˆ™ | å‘½ä»¤1æœ‰æ•ˆ | å‘½ä»¤2æœ‰æ•ˆ | æœ‰é‡å®šå‘ | ç»“æœ |
|------|----------|----------|---------|------|
| R1   | âœ“        | âœ“        | âœ—       | æˆåŠŸ |
| R2   | âœ“        | âœ“        | âœ“       | æˆåŠŸ |
| R3   | âœ“        | âœ—        | âœ—       | å¤±è´¥ |
| R4   | âœ—        | âœ“        | âœ—       | å¤±è´¥ |

**ä»»åŠ¡**ï¼šä¸ºæ¯ä¸ªè§„åˆ™å®ç°æµ‹è¯•ç”¨ä¾‹

ç¤ºä¾‹ï¼š
```cpp
// R1: ä¸¤ä¸ªæœ‰æ•ˆå‘½ä»¤ï¼Œæ— é‡å®šå‘
PipeTestParam{
    "echo 'test' | cat",
    "Both valid, no redirect",
    true,  // should succeed
    "R1"
}
```

#### 5.2 è¾¹ç•Œå€¼æµ‹è¯•

æµ‹è¯•ç‰¹æ®Šæƒ…å†µï¼š
- ç©ºç®¡é“ï¼š` | cat`
- ç®¡é“æœ«å°¾ä¸ºç©ºï¼š`echo test | `
- å¤šé‡ç®¡é“ï¼š`echo test | cat | cat | cat`

### Step 6: è¿è¡Œå’ŒéªŒè¯ï¼ˆ15åˆ†é’Ÿï¼‰

1. **ç¼–è¯‘æ‰€æœ‰æµ‹è¯•**
   ```bash
   cd build
   cmake --build .
   ```

2. **è¿è¡Œæ‰€æœ‰æµ‹è¯•**
   ```bash
   ctest --verbose
   ```

3. **è¿è¡Œç‰¹å®šæµ‹è¯•**
   ```bash
   ./minishell_builtin_test --gtest_filter=*Echo*
   ```

4. **æŸ¥çœ‹æµ‹è¯•ç»“æœ**
   - ç»¿è‰²ï¼šæµ‹è¯•é€šè¿‡ âœ“
   - çº¢è‰²ï¼šæµ‹è¯•å¤±è´¥ âœ—
   - æŸ¥çœ‹å¤±è´¥åŸå› å¹¶ä¿®å¤

## è°ƒè¯•æŠ€å·§

### æŠ€å·§ 1: æ‰‹åŠ¨æµ‹è¯•å‘½ä»¤

å¦‚æœæµ‹è¯•å¤±è´¥ï¼Œå…ˆæ‰‹åŠ¨è¿è¡Œå‘½ä»¤ç¡®è®¤ minishell çš„è¡Œä¸ºï¼š

```bash
cd source/minishell
echo "echo Hello" | ./minishell
```

### æŠ€å·§ 2: ä½¿ç”¨æ–­è¨€æ¶ˆæ¯

æ·»åŠ è¯¦ç»†çš„æ–­è¨€æ¶ˆæ¯å¸®åŠ©è°ƒè¯•ï¼š

```cpp
EXPECT_TRUE(output.find("expected") != std::string::npos)
    << "Expected to find: 'expected'\n"
    << "Actual output: " << output;
```

### æŠ€å·§ 3: åªè¿è¡Œå¤±è´¥çš„æµ‹è¯•

```bash
./minishell_builtin_test --gtest_filter=FailedTestName
```

### æŠ€å·§ 4: è¾“å‡ºè°ƒè¯•ä¿¡æ¯

```cpp
std::cout << "Debug: output = [" << output << "]" << std::endl;
```

## å¸¸è§é”™è¯¯åŠè§£å†³

### é”™è¯¯ 1: æ‰¾ä¸åˆ° minishell

**ç°è±¡**ï¼š`popen() failed!` æˆ–å‘½ä»¤æ‰§è¡Œå¤±è´¥

**è§£å†³**ï¼š
```bash
# ç¡®ä¿ minishell å·²ç¼–è¯‘
cd source/minishell
make

# æ£€æŸ¥æµ‹è¯•åŸºç±»ä¸­çš„è·¯å¾„
# minishell_test_base.h ç¬¬12è¡Œ
std::string minishell_path = "../../source/minishell/minishell";
```

### é”™è¯¯ 2: è¾“å‡ºä¸åŒ¹é…

**ç°è±¡**ï¼šæœŸæœ›è¾“å‡º "Hello"ï¼Œä½†å®é™…è¾“å‡º "minishell$ Hello\nminishell$ "

**è§£å†³**ï¼šä½¿ç”¨éƒ¨åˆ†åŒ¹é…è€Œä¸æ˜¯ç²¾ç¡®åŒ¹é…
```cpp
// âœ— é”™è¯¯
EXPECT_EQ(output, "Hello");

// âœ“ æ­£ç¡®
EXPECT_TRUE(output.find("Hello") != std::string::npos);
```

### é”™è¯¯ 3: æ–‡ä»¶æ“ä½œå¤±è´¥

**ç°è±¡**ï¼šé‡å®šå‘æµ‹è¯•ä¸­æ–‡ä»¶è¯»å†™å¤±è´¥

**è§£å†³**ï¼š
```cpp
// æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
EXPECT_TRUE(fileExists(temp_file)) << "File should exist: " << temp_file;

// æ£€æŸ¥æ–‡ä»¶æƒé™
// ä½¿ç”¨ /tmp ç›®å½•è¿›è¡Œä¸´æ—¶æ–‡ä»¶æ“ä½œ
```

## è¯„ä¼°æ¸…å•

å®Œæˆå®éªŒå‰ï¼Œç¡®ä¿ï¼š

- [ ] æ‰€æœ‰ TODO éƒ½å·²å®Œæˆ
- [ ] ç¼–è¯‘æ— é”™è¯¯æ— è­¦å‘Š
- [ ] æ‰€æœ‰æµ‹è¯•éƒ½èƒ½é€šè¿‡
- [ ] ç†è§£äº†ç­‰ä»·ç±»åˆ’åˆ†çš„åº”ç”¨
- [ ] ç†è§£äº†è¾¹ç•Œå€¼åˆ†æçš„åº”ç”¨
- [ ] ç†è§£äº†å‚æ•°åŒ–æµ‹è¯•çš„ä¼˜åŠ¿
- [ ] èƒ½å¤Ÿè§£é‡Šæµ‹è¯•ç”¨ä¾‹çš„è®¾è®¡ç†ç”±

## å®éªŒæŠ¥å‘Šè¦ç‚¹

åœ¨å®éªŒæŠ¥å‘Šä¸­éœ€è¦è¯´æ˜ï¼š

1. **ç­‰ä»·ç±»åˆ’åˆ†**
   - å¯¹ echo å‘½ä»¤åˆ’åˆ†äº†å“ªäº›ç­‰ä»·ç±»ï¼Ÿ
   - ä¸ºä»€ä¹ˆè¿™æ ·åˆ’åˆ†ï¼Ÿ

2. **è¾¹ç•Œå€¼åˆ†æ**
   - ä¸º cd å‘½ä»¤é€‰æ‹©äº†å“ªäº›è¾¹ç•Œå€¼ï¼Ÿ
   - è¿™äº›è¾¹ç•Œå€¼ä¸ºä»€ä¹ˆé‡è¦ï¼Ÿ

3. **å‚æ•°åŒ–æµ‹è¯•**
   - ä½¿ç”¨å‚æ•°åŒ–æµ‹è¯•çš„ä¼˜åŠ¿æ˜¯ä»€ä¹ˆï¼Ÿ
   - å¦‚ä½•é¿å…ç»„åˆçˆ†ç‚¸ï¼Ÿ

4. **å†³ç­–è¡¨æµ‹è¯•**
   - å¦‚ä½•è®¾è®¡ç®¡é“æµ‹è¯•çš„å†³ç­–è¡¨ï¼Ÿ
   - å¦‚ä½•ç¡®ä¿è¦†ç›–äº†æ‰€æœ‰é‡è¦çš„ç»„åˆï¼Ÿ

## è¿›é˜¶æŒ‘æˆ˜ï¼ˆå¯é€‰ï¼‰

å¦‚æœå®Œæˆäº†åŸºç¡€ä»»åŠ¡ï¼Œå¯ä»¥å°è¯•ï¼š

1. **æµ‹è¯•ä¿¡å·å¤„ç†**
   - Ctrl-C ä¸­æ–­
   - Ctrl-D EOF

2. **æµ‹è¯•å¼•å·åµŒå¥—**
   - `echo "He said 'hello'"`
   - `echo 'She said "hi"'`

3. **æµ‹è¯•å‘½ä»¤åˆ†éš”ç¬¦**
   - `echo A; echo B; echo C`

4. **æµ‹è¯•ç¯å¢ƒå˜é‡**
   - `export VAR=value; echo $VAR`
   - `$?` ç‰¹æ®Šå˜é‡

5. **æµ‹è¯•è¾¹ç•Œæƒ…å†µ**
   - è¶…é•¿å‘½ä»¤
   - ç‰¹æ®Šå­—ç¬¦
   - è·¯å¾„è¾¹ç•Œ

ç¥å®éªŒé¡ºåˆ©ï¼ğŸš€
